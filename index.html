<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบเช็คชื่อนักเรียน ของครูอลิสสา (Cloud Sync)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Prompt', sans-serif; }
        .status-btn.active { transform: scale(1.05); font-weight: bold; ring-width: 2px; }
        /* Loading Overlay */
        #loadingOverlay { backdrop-filter: blur(2px); }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #fff; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-slate-900/50 z-[100] hidden flex flex-col items-center justify-center text-white">
        <div class="spinner mb-4"></div>
        <p id="loadingText" class="text-lg font-medium">กำลังประมวลผล...</p>
    </div>

    <!-- Navbar -->
    <nav class="bg-indigo-600 text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-white/10 p-2 rounded-lg">
                        <i class="fa-solid fa-chalkboard-user text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg leading-none hidden sm:block">ระบบเช็คชื่อของครูอลิสา</h1>
                        <h1 class="font-bold text-lg leading-none sm:hidden">เช็คชื่อ</h1>
                        <p class="text-indigo-200 text-xs">Offline + Cloud Sync</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span id="currentDateDisplay" class="text-indigo-100 text-sm hidden lg:block bg-indigo-700/50 px-3 py-1 rounded-full mr-2"></span>
                    
                    <!-- Cloud Sync Button -->
                    <button onclick="openSyncModal()" class="bg-indigo-500 hover:bg-indigo-400 text-white px-3 py-1.5 rounded-md text-sm font-medium transition shadow flex items-center gap-2 border border-indigo-400">
                        <i class="fa-solid fa-cloud"></i> <span class="hidden sm:inline">Cloud Sync</span>
                    </button>

                    <button onclick="exportToCSV()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-md text-sm font-medium transition shadow flex items-center gap-2">
                        <i class="fa-solid fa-file-csv"></i> <span class="hidden sm:inline">Export</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6 space-y-6">
        
        <!-- Top Controls -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-end">
                
                <!-- Course Selector -->
                <div class="md:col-span-5">
                    <label class="block text-sm font-medium text-slate-600 mb-1.5">
                        <i class="fa-solid fa-book-open text-indigo-500 mr-1"></i> เลือกรายวิชา
                    </label>
                    <div class="flex shadow-sm rounded-md">
                        <select id="courseSelect" onchange="changeCourse()" class="flex-grow rounded-l-md border-slate-300 bg-slate-50 border-y border-l focus:ring-indigo-500 focus:border-indigo-500 py-2.5 px-3 text-slate-700">
                            <!-- Options -->
                        </select>
                        <button onclick="openAddCourseModal()" class="bg-indigo-600 text-white px-4 py-2 hover:bg-indigo-700 border border-indigo-600 border-l-0 transition flex items-center" title="เพิ่มรายวิชา">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                        <button onclick="openEditCourseModal()" class="bg-slate-100 text-slate-600 px-3 py-2 hover:bg-slate-200 border border-slate-300 border-l-0 rounded-r-md transition flex items-center" title="แก้ไข/ตั้งค่าวิชา">
                            <i class="fa-solid fa-gear"></i>
                        </button>
                    </div>
                </div>

                <!-- Date Selector -->
                <div class="md:col-span-3">
                    <label class="block text-sm font-medium text-slate-600 mb-1.5">
                        <i class="fa-regular fa-calendar text-indigo-500 mr-1"></i> วันที่เช็คชื่อ
                    </label>
                    <input type="date" id="dateInput" onchange="loadAttendance()" class="block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2.5 px-3 bg-slate-50">
                </div>

                <!-- Stats Cards -->
                <div class="md:col-span-4 flex justify-between gap-2">
                    <div class="flex-1 bg-green-50 border border-green-100 rounded-lg p-2 text-center">
                        <span class="block text-xs font-bold text-green-600 uppercase tracking-wider">มา</span>
                        <span id="countPresent" class="text-xl font-bold text-green-700 leading-none">0</span>
                    </div>
                    <div class="flex-1 bg-red-50 border border-red-100 rounded-lg p-2 text-center">
                        <span class="block text-xs font-bold text-red-600 uppercase tracking-wider">ขาด</span>
                        <span id="countAbsent" class="text-xl font-bold text-red-700 leading-none">0</span>
                    </div>
                    <div class="flex-1 bg-yellow-50 border border-yellow-100 rounded-lg p-2 text-center">
                        <span class="block text-xs font-bold text-yellow-600 uppercase tracking-wider">สาย</span>
                        <span id="countLate" class="text-xl font-bold text-yellow-700 leading-none">0</span>
                    </div>
                    <div class="flex-1 bg-blue-50 border border-blue-100 rounded-lg p-2 text-center">
                        <span class="block text-xs font-bold text-blue-600 uppercase tracking-wider">ลา</span>
                        <span id="countLeave" class="text-xl font-bold text-blue-700 leading-none">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student List Area -->
        <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden flex flex-col h-full">
            
            <!-- Toolbar -->
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-2">
                    <h2 class="text-lg font-bold text-slate-700 flex items-center">
                        <i class="fa-solid fa-list-ol text-indigo-500 mr-2"></i> รายชื่อนักเรียน
                    </h2>
                    <span id="studentCountBadge" class="bg-slate-200 text-slate-600 text-xs px-2 py-0.5 rounded-full font-medium">0 คน</span>
                </div>
                
                <div class="flex items-center gap-2 w-full sm:w-auto overflow-x-auto">
                    <button onclick="markAll('present')" class="flex-shrink-0 text-xs font-medium bg-green-100 text-green-700 px-4 py-2 rounded-full hover:bg-green-200 transition">
                        <i class="fa-solid fa-check-double mr-1"></i> มาครบทุกคน
                    </button>
                    <div class="w-px h-6 bg-slate-300 mx-1"></div>
                    <button onclick="openManageStudentsModal()" class="flex-shrink-0 text-xs font-medium bg-indigo-50 text-indigo-700 px-4 py-2 rounded-full hover:bg-indigo-100 transition border border-indigo-100">
                        <i class="fa-solid fa-user-pen mr-1"></i> แก้ไขรายชื่อ
                    </button>
                    <button onclick="openImportModal()" class="flex-shrink-0 text-xs font-medium bg-emerald-50 text-emerald-700 px-4 py-2 rounded-full hover:bg-emerald-100 transition border border-emerald-100">
                        <i class="fa-solid fa-file-import mr-1"></i> นำเข้า Excel
                    </button>
                </div>
            </div>

            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                        <tr>
                            <th class="px-6 py-3 w-16 text-center">#</th>
                            <th class="px-6 py-3 w-28">รหัส</th>
                            <th class="px-6 py-3 min-w-[200px]">ชื่อ-นามสกุล</th>
                            <th class="px-6 py-3 text-center min-w-[240px]">สถานะ</th>
                            <th class="px-6 py-3 min-w-[200px]">หมายเหตุ</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>

            <!-- Empty States -->
            <div id="emptyState" class="hidden flex-col items-center justify-center py-16 text-center px-4">
                <div class="bg-indigo-50 p-4 rounded-full mb-4">
                    <i class="fa-solid fa-layer-group text-3xl text-indigo-400"></i>
                </div>
                <h3 class="text-lg font-medium text-slate-900">เริ่มใช้งานระบบเช็คชื่อ</h3>
                <p class="text-slate-500 max-w-sm mt-1 mb-6">สร้างรายวิชาใหม่ หรือเลือกวิชาที่มีอยู่เพื่อเริ่มบันทึกเวลาเรียน</p>
                <button onclick="openAddCourseModal()" class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg shadow hover:bg-indigo-700 font-medium transition">
                    <i class="fa-solid fa-plus mr-2"></i> สร้างรายวิชาใหม่
                </button>
            </div>
            
            <div id="noStudentsState" class="hidden flex-col items-center justify-center py-12 text-center px-4">
                <p class="text-slate-500 mb-4">วิชานี้ยังไม่มีรายชื่อนักเรียน</p>
                <div class="flex gap-3">
                     <button onclick="openManageStudentsModal()" class="text-indigo-600 bg-indigo-50 px-4 py-2 rounded-lg hover:bg-indigo-100 font-medium">เพิ่มทีละคน</button>
                     <button onclick="openImportModal()" class="text-emerald-600 bg-emerald-50 px-4 py-2 rounded-lg hover:bg-emerald-100 font-medium">นำเข้าจาก Excel</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- 1. Add Course -->
    <div id="addCourseModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModals()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 class="text-xl font-bold text-slate-800 mb-1 flex items-center">
                <i class="fa-solid fa-folder-plus text-indigo-600 mr-2"></i> สร้างรายวิชาใหม่
            </h3>
            <p class="text-sm text-slate-500 mb-5">กำหนดชื่อวิชาและห้องเรียน</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">ชื่อวิชา</label>
                    <input type="text" id="newSubjectName" placeholder="เช่น คณิตศาสตร์" class="w-full border-slate-300 rounded-lg p-2.5 border">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">ห้องเรียน</label>
                    <div class="relative">
                        <input type="text" id="newRoomName" list="existingRooms" placeholder="เช่น ม.1/1" class="w-full border-slate-300 rounded-lg p-2.5 border" onchange="checkExistingRoom()">
                        <datalist id="existingRooms"></datalist>
                    </div>
                    <p id="roomHint" class="text-xs mt-1 text-slate-400">ใส่ชื่อห้องเดิมเพื่อใช้รายชื่อนักเรียนร่วมกัน</p>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="closeModals()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">ยกเลิก</button>
                <button onclick="addNewCourse()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">บันทึก</button>
            </div>
        </div>
    </div>

    <!-- 2. Edit Course -->
    <div id="editCourseModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModals()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl shadow-2xl w-full max-w-lg p-0 overflow-hidden">
            <div class="bg-slate-50 px-6 py-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-slate-800">ตั้งค่ารายวิชา</h3>
                <button onclick="closeModals()" class="text-slate-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 space-y-6">
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-slate-700">แก้ไขชื่อรายวิชา</label>
                    <div class="flex gap-2">
                        <input type="text" id="editSubjectName" class="flex-grow border-slate-300 rounded-lg p-2 border">
                        <button onclick="saveCourseName()" class="bg-indigo-600 text-white px-3 rounded-lg text-sm">บันทึก</button>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-slate-700">แก้ไขชื่อห้องเรียน</label>
                    <div class="flex gap-2">
                        <input type="text" id="editRoomName" class="flex-grow border-slate-300 rounded-lg p-2 border">
                        <button onclick="saveRoomName()" class="bg-indigo-600 text-white px-3 rounded-lg text-sm">บันทึก</button>
                    </div>
                </div>
                <div class="bg-red-50 p-4 rounded-lg border border-red-100">
                    <button onclick="deleteCourse()" class="text-sm text-red-600 hover:text-red-800 font-medium">ลบรายวิชานี้ (Delete Course)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Manage Students -->
    <div id="manageStudentModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModals()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl shadow-2xl w-full max-w-2xl h-[85vh] flex flex-col">
            <div class="px-6 py-4 border-b bg-slate-50 rounded-t-xl flex justify-between">
                <h3 class="font-bold text-slate-800">จัดการรายชื่อนักเรียน</h3>
                <button onclick="closeModals()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4 bg-white border-b">
                <div class="flex gap-2">
                    <input type="text" id="addStuId" placeholder="รหัส" class="w-24 border rounded-lg px-3 py-2 text-sm">
                    <input type="text" id="addStuName" placeholder="ชื่อ-นามสกุล" class="flex-grow border rounded-lg px-3 py-2 text-sm">
                    <button onclick="addStudentManual()" class="bg-indigo-600 text-white px-4 rounded-lg text-sm">เพิ่ม</button>
                </div>
            </div>
            <div class="flex-grow overflow-y-auto p-2">
                <table class="w-full text-sm"><tbody id="manageStudentList" class="divide-y"></tbody></table>
            </div>
        </div>
    </div>

    <!-- 4. Import Excel -->
    <div id="importModal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModals()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <h3 class="font-bold mb-2">นำเข้าจาก Excel / Sheets</h3>
            <textarea id="importText" rows="6" class="w-full border p-3 text-sm font-mono bg-emerald-50/30 rounded-lg mb-4" placeholder="101   สมชาย&#10;102   สมหญิง"></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="closeModals()" class="px-4 py-2 hover:bg-slate-100 rounded-lg">ยกเลิก</button>
                <button onclick="processImport()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg">ยืนยันนำเข้า</button>
            </div>
        </div>
    </div>

    <!-- 5. Cloud Sync Modal (NEW) -->
    <div id="syncModal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModals()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <div class="flex items-center gap-3 mb-4">
                <div class="bg-indigo-100 p-2 rounded-full text-indigo-600"><i class="fa-solid fa-cloud text-xl"></i></div>
                <h3 class="text-xl font-bold text-slate-800">เชื่อมต่อ Google Sheets</h3>
            </div>

            <!-- URL Setup -->
            <div class="mb-6">
                <label class="block text-sm font-bold text-slate-700 mb-1">Web App URL (จาก Apps Script)</label>
                <input type="text" id="gasUrlInput" placeholder="https://script.google.com/macros/s/..." class="w-full border-slate-300 rounded-lg p-2.5 text-sm focus:ring-indigo-500 focus:border-indigo-500 border">
                <p class="text-xs text-slate-400 mt-1">ใช้ URL ที่ได้จากการ Deploy Web App (ตั้งค่าเป็น 'Anyone')</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="uploadToCloud()" class="flex flex-col items-center justify-center p-4 border-2 border-slate-100 rounded-xl hover:border-indigo-500 hover:bg-indigo-50 transition group">
                    <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 group-hover:text-indigo-600 mb-2"></i>
                    <span class="font-bold text-slate-700">อัปโหลดขึ้น Cloud</span>
                    <span class="text-xs text-slate-500 text-center">ส่งข้อมูลจากเครื่องนี้ไปเก็บไว้</span>
                </button>

                <button onclick="downloadFromCloud()" class="flex flex-col items-center justify-center p-4 border-2 border-slate-100 rounded-xl hover:border-emerald-500 hover:bg-emerald-50 transition group">
                    <i class="fa-solid fa-cloud-arrow-down text-3xl text-slate-400 group-hover:text-emerald-600 mb-2"></i>
                    <span class="font-bold text-slate-700">ดาวน์โหลดลงเครื่อง</span>
                    <span class="text-xs text-slate-500 text-center">ดึงข้อมูลล่าสุดมาใช้</span>
                </button>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button onclick="closeModals()" class="text-slate-500 hover:text-slate-700 text-sm">ปิดหน้าต่าง</button>
            </div>
        </div>
    </div>

    <script>
        // Data Structure v2 + Sync Config
        let appData = {
            version: 2,
            rooms: {},
            courses: {},
            attendance: {},
            notes: {},
            config: {
                gasUrl: ""
            }
        };
        let currentCourseId = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateInput').value = today;
            updateDateDisplay();
            
            renderCourseSelector();
            const cIds = Object.keys(appData.courses);
            if (cIds.length > 0) {
                currentCourseId = cIds[0];
                document.getElementById('courseSelect').value = currentCourseId;
                renderMain();
            } else {
                renderEmptyState();
            }
            
            // Restore URL if saved
            if(appData.config && appData.config.gasUrl) {
                document.getElementById('gasUrlInput').value = appData.config.gasUrl;
            }
        });

        // --- Core Functions ---
        function loadData() {
            const stored = localStorage.getItem('teacherAttendanceSystem');
            if (stored) {
                const parsed = JSON.parse(stored);
                if (!parsed.version) migrateV1toV2(parsed);
                else appData = parsed;
            }
            if(!appData.config) appData.config = { gasUrl: "" };
        }

        function saveData() {
            localStorage.setItem('teacherAttendanceSystem', JSON.stringify(appData));
        }

        function migrateV1toV2(oldData) {
            if (oldData.classes) {
                Object.keys(oldData.classes).forEach(oldName => {
                    const roomId = generateUUID();
                    const students = oldData.classes[oldName];
                    appData.rooms[roomId] = { id: roomId, name: oldName, students: students };
                    const courseId = generateUUID();
                    appData.courses[courseId] = { id: courseId, subject: "วิชาทั่วไป", roomId: roomId };
                    
                    if (oldData.attendance) {
                        Object.keys(oldData.attendance).forEach(key => {
                            if (key.startsWith(oldName + "_")) {
                                const newKey = `${courseId}_${key.substring(oldName.length + 1)}`;
                                appData.attendance[newKey] = oldData.attendance[key];
                            }
                        });
                    }
                });
            }
            saveData();
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // --- Cloud Sync Logic ---
        function openSyncModal() {
            document.getElementById('syncModal').classList.remove('hidden');
        }

        function showLoading(text) {
            document.getElementById('loadingText').innerText = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        async function uploadToCloud() {
            const url = document.getElementById('gasUrlInput').value.trim();
            if(!url) { alert('กรุณาใส่ Web App URL ก่อนครับ'); return; }
            
            // Save URL config
            appData.config.gasUrl = url;
            saveData();

            showLoading('กำลังอัปโหลดข้อมูลไปเก็บที่ Google Sheets...');
            
            try {
                // Using no-cors might prevent reading response but allows sending data without pre-flight issues in some cases.
                // However, GAS Web App usually handles CORS if returning JSON properly.
                // We send data as plain string payload to avoid complex pre-flights if possible.
                
                const response = await fetch(url, {
                    method: 'POST',
                    body: JSON.stringify(appData)
                });
                
                const result = await response.json();
                
                if(result.result === 'success' || result.status === 'success') {
                    alert('✅ อัปโหลดสำเร็จ! ข้อมูลถูกเก็บใน Google Sheets แล้ว');
                } else {
                    alert('⚠️ อัปโหลดแล้ว แต่เซิร์ฟเวอร์ตอบกลับแปลกๆ: ' + JSON.stringify(result));
                }
            } catch (e) {
                console.error(e);
                alert('❌ เกิดข้อผิดพลาด: ' + e.message + '\n(ตรวจสอบ URL หรือการตั้งค่าสิทธิ์ Deploy)');
            } finally {
                hideLoading();
            }
        }

        async function downloadFromCloud() {
            const url = document.getElementById('gasUrlInput').value.trim();
            if(!url) { alert('กรุณาใส่ Web App URL ก่อนครับ'); return; }
            
            appData.config.gasUrl = url;
            saveData();

            showLoading('กำลังดึงข้อมูลจาก Google Sheets...');
            
            try {
                const response = await fetch(url);
                const cloudData = await response.json();
                
                if(cloudData && (cloudData.courses || cloudData.rooms)) {
                    if(confirm('พบข้อมูลบน Cloud! ต้องการนำมาทับข้อมูลในเครื่องนี้หรือไม่? (ข้อมูลปัจจุบันในเครื่องจะหายไป)')) {
                        appData = cloudData;
                        saveData();
                        location.reload(); // Reload to refresh UI
                    }
                } else {
                    alert('ไม่พบข้อมูลรูปแบบที่ถูกต้องบน Cloud (หรือ Database ว่างเปล่า)');
                }
            } catch (e) {
                console.error(e);
                alert('❌ ดาวน์โหลดไม่ได้: ' + e.message);
            } finally {
                hideLoading();
            }
        }

        // --- Render UI ---
        function renderCourseSelector() {
            const select = document.getElementById('courseSelect');
            select.innerHTML = '';
            const courses = Object.values(appData.courses);
            if (courses.length === 0) {
                select.innerHTML = '<option>-- ไม่มีรายวิชา --</option>';
                return;
            }
            courses.forEach(c => {
                const room = appData.rooms[c.roomId];
                const roomName = room ? room.name : "?";
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.text = `${c.subject} (${roomName})`;
                select.appendChild(opt);
            });
            
            // Datalist
            const datalist = document.getElementById('existingRooms');
            datalist.innerHTML = '';
            new Set(Object.values(appData.rooms).map(r => r.name)).forEach(n => {
                const opt = document.createElement('option');
                opt.value = n;
                datalist.appendChild(opt);
            });
        }

        function changeCourse() {
            currentCourseId = document.getElementById('courseSelect').value;
            renderMain();
        }

        function renderMain() {
            if (!currentCourseId || !appData.courses[currentCourseId]) {
                renderEmptyState();
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');
            const course = appData.courses[currentCourseId];
            const room = appData.rooms[course.roomId];
            
            if (!room || room.students.length === 0) {
                document.querySelector('.overflow-x-auto').classList.add('hidden');
                document.getElementById('noStudentsState').classList.remove('hidden');
                document.getElementById('noStudentsState').classList.add('flex');
                document.getElementById('studentCountBadge').innerText = "0 คน";
            } else {
                document.querySelector('.overflow-x-auto').classList.remove('hidden');
                document.getElementById('noStudentsState').classList.add('hidden');
                document.getElementById('noStudentsState').classList.remove('flex');
                document.getElementById('studentCountBadge').innerText = `${room.students.length} คน`;
                renderAttendanceTable(room.students);
            }
            updateStats();
        }

        function renderAttendanceTable(students) {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';
            const date = document.getElementById('dateInput').value;
            const key = `${currentCourseId}_${date}`;
            const records = appData.attendance[key] || {};
            const notes = appData.notes[key] || {};

            students.forEach((s, idx) => {
                const status = records[idx] || 'present';
                const note = notes[idx] || '';
                
                const statuses = [
                    { val: 'present', label: 'มา', color: 'green', icon: 'fa-check' },
                    { val: 'late', label: 'สาย', color: 'yellow', icon: 'fa-clock' },
                    { val: 'absent', label: 'ขาด', color: 'red', icon: 'fa-xmark' },
                    { val: 'leave', label: 'ลา', color: 'blue', icon: 'fa-envelope' }
                ];

                let btns = `<div class="flex justify-center bg-slate-100 rounded-lg p-1 inline-flex w-full sm:w-auto">`;
                statuses.forEach(st => {
                    const active = status === st.val ? `bg-white text-${st.color}-600 shadow-sm ring-1 ring-${st.color}-200 font-bold` : `text-slate-400 hover:text-slate-600`;
                    btns += `<button onclick="setStatus(${idx}, '${st.val}')" class="flex-1 sm:flex-none px-2 py-1.5 rounded-md text-xs flex items-center justify-center gap-1 transition ${active}"><i class="fa-solid ${st.icon}"></i><span class="hidden lg:inline">${st.label}</span></button>`;
                });
                btns += `</div>`;

                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-slate-50";
                tr.innerHTML = `
                    <td class="px-6 py-3 text-center text-slate-400 font-mono text-xs">${idx+1}</td>
                    <td class="px-6 py-3 font-medium text-slate-600 text-xs">${s.id}</td>
                    <td class="px-6 py-3 text-slate-800 font-medium">${s.name}</td>
                    <td class="px-6 py-3 text-center">${btns}</td>
                    <td class="px-6 py-3"><input type="text" value="${note}" onchange="setNote(${idx}, this.value)" class="w-full text-xs border-slate-200 border rounded px-2 py-1.5 bg-transparent focus:bg-white" placeholder="บันทึก..."></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function setStatus(idx, status) {
            const key = `${currentCourseId}_${document.getElementById('dateInput').value}`;
            if (!appData.attendance[key]) appData.attendance[key] = {};
            appData.attendance[key][idx] = status;
            saveData();
            renderMain();
        }

        function setNote(idx, val) {
            const key = `${currentCourseId}_${document.getElementById('dateInput').value}`;
            if (!appData.notes[key]) appData.notes[key] = {};
            appData.notes[key][idx] = val;
            saveData();
        }

        function markAll(status) {
            if(!currentCourseId) return;
            const course = appData.courses[currentCourseId];
            const room = appData.rooms[course.roomId];
            if(!room || !room.students.length) return;
            const key = `${currentCourseId}_${document.getElementById('dateInput').value}`;
            if (!appData.attendance[key]) appData.attendance[key] = {};
            room.students.forEach((_, i) => appData.attendance[key][i] = status);
            saveData();
            renderMain();
        }

        function updateStats() {
            if(!currentCourseId) return;
            const key = `${currentCourseId}_${document.getElementById('dateInput').value}`;
            const records = appData.attendance[key] || {};
            let c = { present: 0, absent: 0, late: 0, leave: 0 };
            const course = appData.courses[currentCourseId];
            const room = appData.rooms[course.roomId];
            if(room) {
                room.students.forEach((_, i) => {
                    c[records[i] || 'present']++;
                });
            }
            document.getElementById('countPresent').innerText = c.present;
            document.getElementById('countAbsent').innerText = c.absent;
            document.getElementById('countLate').innerText = c.late;
            document.getElementById('countLeave').innerText = c.leave;
        }

        function updateDateDisplay() {
            const d = new Date(document.getElementById('dateInput').value);
            document.getElementById('currentDateDisplay').textContent = d.toLocaleDateString('th-TH', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
        }
        function loadAttendance() { updateDateDisplay(); renderMain(); }

        function renderEmptyState() {
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('flex');
            document.querySelector('.overflow-x-auto').classList.add('hidden');
            document.getElementById('noStudentsState').classList.add('hidden');
        }

        // --- Modals Logic ---
        function closeModals() { document.querySelectorAll('.fixed').forEach(e => e.classList.add('hidden')); }
        function openAddCourseModal() { document.getElementById('addCourseModal').classList.remove('hidden'); }
        function openEditCourseModal() { 
            if(!currentCourseId) return;
            const c = appData.courses[currentCourseId];
            document.getElementById('editSubjectName').value = c.subject;
            document.getElementById('editRoomName').value = appData.rooms[c.roomId].name;
            document.getElementById('editCourseModal').classList.remove('hidden');
        }
        function openManageStudentsModal() {
            if(!currentCourseId) return;
            const r = appData.rooms[appData.courses[currentCourseId].roomId];
            const list = document.getElementById('manageStudentList');
            list.innerHTML = '';
            r.students.forEach((s, i) => {
                list.innerHTML += `<tr><td class="p-3 text-slate-500">${s.id}</td><td class="p-3 font-medium">${s.name}</td><td class="p-3 text-right"><button onclick="removeStudent(${i})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash-can"></i></button></td></tr>`;
            });
            document.getElementById('manageStudentModal').classList.remove('hidden');
        }
        function openImportModal() { document.getElementById('importModal').classList.remove('hidden'); }
        
        // --- Action Logic ---
        function checkExistingRoom() {
            const exists = Object.values(appData.rooms).some(r => r.name === document.getElementById('newRoomName').value.trim());
            document.getElementById('roomHint').innerHTML = exists ? `<span class="text-green-600"><i class="fa-solid fa-check-circle"></i> ใช้รายชื่อเดิมที่มีอยู่</span>` : `สร้างห้องใหม่`;
        }
        function addNewCourse() {
            const sub = document.getElementById('newSubjectName').value.trim();
            const rmName = document.getElementById('newRoomName').value.trim();
            if(!sub || !rmName) return alert('กรอกให้ครบครับ');
            let rId = null;
            const existR = Object.values(appData.rooms).find(r => r.name === rmName);
            if(existR) rId = existR.id;
            else { rId = generateUUID(); appData.rooms[rId] = { id: rId, name: rmName, students: [] }; }
            const cId = generateUUID();
            appData.courses[cId] = { id: cId, subject: sub, roomId: rId };
            saveData(); renderCourseSelector(); document.getElementById('courseSelect').value = cId; changeCourse(); closeModals();
        }
        function saveCourseName() {
            if(currentCourseId) {
                appData.courses[currentCourseId].subject = document.getElementById('editSubjectName').value.trim();
                saveData(); renderCourseSelector(); document.getElementById('courseSelect').value = currentCourseId; alert('บันทึกชื่อวิชาแล้ว');
            }
        }
        function saveRoomName() {
            if(currentCourseId) {
                appData.rooms[appData.courses[currentCourseId].roomId].name = document.getElementById('editRoomName').value.trim();
                saveData(); renderCourseSelector(); document.getElementById('courseSelect').value = currentCourseId; alert('บันทึกชื่อห้องแล้ว');
            }
        }
        function deleteCourse() {
            if(confirm('ลบวิชานี้?')) {
                delete appData.courses[currentCourseId];
                saveData(); renderCourseSelector();
                const keys = Object.keys(appData.courses);
                currentCourseId = keys.length ? keys[0] : null;
                if(currentCourseId) document.getElementById('courseSelect').value = currentCourseId;
                renderMain(); closeModals();
            }
        }
        function addStudentManual() {
            const id = document.getElementById('addStuId').value.trim();
            const name = document.getElementById('addStuName').value.trim();
            if(name) {
                appData.rooms[appData.courses[currentCourseId].roomId].students.push({id, name});
                saveData(); openManageStudentsModal(); renderMain();
                document.getElementById('addStuId').value=''; document.getElementById('addStuName').value='';
            }
        }
        function removeStudent(i) {
            if(confirm('ลบรายชื่อ?')) {
                appData.rooms[appData.courses[currentCourseId].roomId].students.splice(i, 1);
                saveData(); openManageStudentsModal(); renderMain();
            }
        }
        function processImport() {
            const lines = document.getElementById('importText').value.split('\n');
            let c=0;
            const r = appData.rooms[appData.courses[currentCourseId].roomId];
            lines.forEach(l => {
                let p = l.split(/[\t,]/).map(x=>x.trim().replace(/^"|"$/g,''));
                let id='', nm='';
                if(p.length>=2) { id=p[0]; nm=p[1]; } else if(p.length==1) nm=p[0];
                if(nm) { r.students.push({id, name:nm}); c++; }
            });
            if(c>0) { saveData(); renderMain(); alert(`เพิ่ม ${c} คน`); document.getElementById('importText').value=''; closeModals(); }
        }
        function exportToCSV() {
            if(!currentCourseId) return;
            const c = appData.courses[currentCourseId];
            const r = appData.rooms[c.roomId];
            let csv = "\uFEFFวันที่,รหัสนักเรียน,ชื่อ,สถานะ,หมายเหตุ\n";
            const map = {present:'มา', absent:'ขาด', late:'สาย', leave:'ลา'};
            const dates = [...new Set(Object.keys(appData.attendance).filter(k=>k.startsWith(currentCourseId)).map(k=>k.split('_')[1])), document.getElementById('dateInput').value].sort();
            dates.forEach(d => {
                const k = `${currentCourseId}_${d}`;
                r.students.forEach((s, i) => {
                    csv += `${d},"${s.id}","${s.name}",${map[appData.attendance[k]?.[i]||'present']},"${appData.notes[k]?.[i]||''}"\n`;
                });
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8;'}));
            link.download = `CheckName_${c.subject}.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
    </script>
</body>

</html>
